	TITLE	'Einzelzeicheneingabe fuer KMBG'	PAGE;	PN	UK;----------------------------------------------------------------------;;        Einzelzeicheneingabe fuer KMBG;;----------------------------------------------------------------------;UK.GETK:	CALL	U1.RSAVE	CALL	XY.LIDX	;HL:= Blocklaenge	DB	7	PUSH	HL	CALL	XY.LDDX	DB	23	EX	DE,HL	;DE:= Pufferzaehler	XOR	A	POP	HL	;HL:= Blocklaenge	SBC	HL,DE	PUSH	HL	;Restbyteanzahl retten	LD	A,H	OR	L	CALL	Z,UK.KBW	;Block lesen	POP	HL	XOR	A	CP	H	JR	NZ,UK.GETK2	LD	A,L	CP	1	JR	Z,UK.GETK3	;---> letztes Datenbyte desUK.GETK2:	CALL	UK.GETK4	OR	AUK.GETK5:	CALL	U1.RRST	RET;;UK.GETK3:	CALL	UK.GETK4	SCF	JR	UK.GETK5;UK.GETK4:	CALL	XY.LDDX	;HL:= aktuelle Pufferadresse	DB	21	LD	A,(HL)	;Datenbyte laden	CALL	XY.INCDX	;Pufferzeiger erhoehen	DB	21	CALL	XY.INCDX	;Pufferzaehler erhoehen	DB	23	RET;;******************************************************************;;        KMBG  Eingabepuffer bereitstellen;;*******************************************************************;UK.KLPFB:	CALL	U1.RSAVE	CALL	U1.KTIN1	LD	HL,100H	;max. Blocklaenge Kassette	CALL	XY.STIDX	;max. Blocklaenge initialisieren	DB	7	PUSH	HL	POP	BC	;BC:= Blocklaenge	CALL	XY.STDX	;Pufferzaehler "Leer"	DB	23	LD	HL,UE.PUF	;Systempuffer Kassette	CALL	U1.CLRB	;Systempuffer loeschen	LD	HL,UE.KPUFF	CALL	U1.CLRB	CALL	U1.RRST	RET;;******************************************************************;;        Einlesen eines Blockes von Kassette;;         - Besonderheit gegenueber MBW: Blockinhalt wird vom;           Systempuffer in den E/A-Puffer uebertragen;;*******************************************************************;UK.KBW:	CALL	U1.RSAVE	CALL	UK.KLPFB	LD	(IX+4),02H	CALL	UF.EXEC	LD	A,(IX+9)	OR	(IX+10)	JR	Z,UK.KBW1	;EOF	CALL	XY.LDDX	;HL:= Blockadresse	DB	7	LD	B,(IX+9)	;BC:= Blocklaenge	LD	C,(IX+10)	PUSH	HL	;E/A-Puffer	CALL	XY.LDDX	DB	25	EX	DE,HL	POP	HL	LDIR		;Transport in E/A-Puffer	CALL	XY.LDDX	DB	25	CALL	XY.STDX	;Pufferzeiger auf Anfang	DB	21	LD	HL,0	CALL	XY.STDX	;Pufferzaehler rueckstellen	DB	23	CALL	XY.INCDX	;Blockzaehler incrementieren	DB	17UK.KBW2:	CALL	U1.RRST	RET;UK.KBW1:	CALL	XY.INCDX	;Labelzaehler incrementieren	DB	17	JR	UK.KBW2;;********************************************************************;;        Einzelzeichenausgabe fuer KMBG;;*********************************************************************;UK.PUTK:	CALL	U1.RSAVE	PUSH	AF	;Zeichen retten	CALL	XY.LDDX	;HL:= Pufferzaehler	DB	23	LD	BC,UE.KMPUL	;BC:= max. Pufferlaenge	OR	A	SBC	HL,BC	CCF	CALL	Z,UK.KBA	;---> Puffer voll	POP	AF	;Zeichen auskellern	CALL	XY.LDDX	DB	21	LD	(HL),A	;Zeichen in Puffer eintragen	CALL	XY.INCDX	;Pufferzeiger erhoehen	DB	21	CALL	XY.INCDX	;Pufferzaehler erhoehen	DB	23	CALL	U1.RRST	RET;;******************************************************************;;        Ausgabepufferbereitstellung fuer KMBG;;*******************************************************************;UK.KSPFB:	CALL	U1.RSAVE	CALL	U1.KTIN1	CALL	XY.LIDX	DB	7	PUSH	HL	POP	BC	;BC:= Blocklaenge	LD	HL,0	CALL	XY.STDX	;Pufferzaehler = 0	DB	23	CALL	XY.LDDX	DB	25	CALL	XY.STDX	;Pufferzeiger setzen	DB	21	LD	HL,UE.PUF	CALL	U1.CLRB	CALL	U1.RRST	RET;;*******************************************************************;;        Ausgabe eines Blockes auf KMBG;;*******************************************************************;UK.KBA:	CALL	U1.RSAVE	CALL	UK.KSPFB	CALL	XY.LDDX	DB	7	EX	DE,HL	;DE:= Blockadresse	PUSH	DE	;Blockadresse retten	CALL	XY.LIDX	DB	9	PUSH	HL	POP	BC	;BC:= Blocklaenge	POP	DE	;DE:= Blockadresse	PUSH	BC	;Blocklaenge retten	CALL	XY.LDDX	;HL:= E/A-Pufferanfang	DB	25	LDIR		;Block in Systempuffer	POP	BC	;BC:= Blocklaenge	PUSH	HL	;aktuelle Pufferadresse retten	LD	HL,UE.KMPUL	;HL:= max. Laenge	OR	A	SBC	HL,BC	;HL:= Restbyteanzahl	CALL	XY.STDX	;Pufferzaehler setzen	DB	23	PUSH	HL	POP	BC	;BC:= Restbyteanzahl	CALL	XY.LDDX	;HL:= aktuelle Pufferadresse	DB	25	EX	DE,HL	;DE:= Pufferanfang	POP	HL	LDIR	EX	DE,HL	;HL:= aktuelle Pufferadresse	CALL	XY.STDX	;Pufferzeiger setzen	DB	21	LD	(IX+4),00H	CALL	UF.EXEC	;physische Blockausgabe	PUSH	AF	CALL	XY.INCDX	;Blockzaehler erhoehen	DB	17	POP	AF	CALL	U1.RRST	RET;----------------------------------------------------------------------;	END