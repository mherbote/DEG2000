	TITLE	'Ein-/Ausgabe im freien Format'	PAGE;	PN	FD;**********************************************************************;;      Ein-/Ausgabe von Dateien im freien Format in bzw. aus demEditor-;      raum von bzw. auf MRES-Kassetten;;**********************************************************************;      Positionieren auf Datei, IN: <C>:= Labelnummer;FD.POSK:	PUSH	BC	LD	B,C	INC	B	CALL	UR.POSIK	CALL	FD.KO01	LD	A,(UE.PUF)	CP	C	POP	BC	JR	NZ,$+3	RET	POP	DE	LD	A,94H	CALL	UF.ERANZ	RET;FD.KO01:	LD	(IX+5),2	;FUER FD19	JP	UF.EXEC;----------------------------------------------------------------------;      Datei im Verzeichnis suchen;      HL:= Dateiname, <B>:= Anzahl Verzeichniseintragungen + 1;      <D>:= Dateityp;      O:  CY:= 0 Datei nicht vorhanden, <C> unveraendert;          CY:= 1 <C>:= Labelnummer;      K:  BFD.DASU:	PUSH	DE	DEC	B	JR	Z,$+12	CALL	FD.KO01	CALL	U1.NMVGL	JR	C,$+7	DJNZ	$-8	OR	A	POP	DE	RET	LD	E,A	LD	A,(UE.PUF+6)	CP	D	JR	NZ,$-10	LD	C,E	SCF	JR	$-11;----------------------------------------------------------------------;      Reservebloecke schreiben;FD.WRRES:	PUSH	BC	PUSH	DE	PUSH	HL	LD	HL,UA.ZKRES	CALL	UR.MIMO	EX	DE,HL	CALL	UC.CVDB	LD	A,H	OR	L	JR	NZ,$+6	POP	HL	POP	DE	POP	BC	RET	PUSH	HL	LD	HL,UE.PUF	LD	BC,90H	CALL	U1.CLRB	LD	HL,80H	CALL	XY.STIDX	DB	9	POP	HL	CALL	UK.KBA	DEC	HL	LD	A,H	OR	L	JR	NZ,$-24	JR	$-30;----------------------------------------------------------------------;      F/S - Datei in den Editorraum einlesen;FD.FDINP:	LD	HL,0	CALL	XY.STDX	DB	17	CALL	UK.KLPFB	;Pufferbereitstellung	LD	HL,UE.BWSA+328H	LD	B,5	LD	A,(HL)	CP	'E'	JR	Z,$+7	INC	HL	DJNZ	$-6	JR	$+7	LD	HL,(UE.EDEND)	JR	$+5	LD	HL,UE.TEXAN	EXX	CALL	DC.INIT	;Dekomprimierung initialisieren	EXX	LD	A,(UB.PAR2)	;Dateitypmerker	CP	'S'	PUSH	AF	CALL	Z,FD.SDIN	;Zeicheneingabe S- Datei	LD	(HL),A	OR	A	JR	Z,$+20	POP	AF	JR	Z,$+9	CALL	NZ,UK.GETK	;Zeicheneingabe F- Datei	LD	(HL),A	;Zeichen in Speicher eintragen	CP	(HL)	;Echolesen	JR	NZ,$+18	OR	A	;<A>:= 0, Z:= 1	RET	Z	INC	HL	;HL:= HL + 1	LD	(UE.EDEND),HL	;Textende	JR	$-29	POP	AF	RETFD.SDIN:	EXX	CALL	DC.DCMPR	EXX	RET	LD	A,93H	;Fehlerschluessel	CALL	UF.ERANZ	RET;----------------------------------------------------------------------;      Ausgabe einer F/S - Datei (neuer Bestand);FD.FDOUT:	LD	HL,0	;Blockzaehler loeschen	CALL	XY.STDX	DB	17	LD	HL,80H	;Blocklaenge eintragen	CALL	XY.STIDX	DB	9	CALL	UK.KSPFB	;Pufferbereitstellung	LD	HL,UE.TEXAN	;HL:= Textanfang	LD	DE,(UE.EDEND)	;BC:= Textende	EXX	CALL	CP.INIT	EXX	OR	A	;CY:= 0	PUSH	HL	SBC	HL,DE	JR	NC,$+21	POP	HL	LD	A,(UB.PAR2)	CP	'S'	PUSH	AF	LD	A,(HL)	CALL	Z,FD.SDOUT	POP	AF	LD	A,(HL)	CALL	NZ,UK.PUTK	INC	HL	JR	$-23	POP	HL	;Endebehandlung	LD	BC,288	XOR	A	CALL	UK.PUTK	DEC	BC	LD	A,B	OR	C	JR	NZ,$-7	CALL	FD.DSPBB	CALL	FD.WRRES	;Reservebloecke schreiben	CALL	XY.LDDX	;HL:= Blockzaehler	DB	17	RETFD.SDOUT:	EXX	CALL	CP.COMPR	EXX	RET;----------------------------------------------------------------------;      Ausgabe einer F/S - Datei (alter Bestand);FD.FDOWR:	LD	HL,0	CALL	XY.STDX	DB	17	LD	HL,UE.TEXAN	EXX	CALL	CP.INIT	EXX	PUSH	HLFD.FDOW1:	CALL	FD.FDUP	POP	HLFD.FDOW2:	PUSH	HL	LD	DE,(UE.EDEND)	OR	A	SBC	HL,DE	JR	NC,FD.FDOW3	POP	HL	LD	A,(UB.PAR2)	CP	'S'	LD	A,(HL)	JR	Z,FD.SDOW	CALL	UK.PUTK	DEC	BCFD.FDOW4:	INC	HL	LD	A,B	OR	C	JR	NZ,FD.FDOW2	CALL	UK.KBA	;Block schreiben	PUSH	HL	CALL	FD.DECBZ	JR	FD.FDOW1FD.FDOW3:	POP	HL	XOR	A	;Endekennzeichen 00H 	CALL	UK.PUTK	CALL	UK.KBA	CALL	FD.DECBZ	OR	A	RETFD.DECBZ:	CALL	XY.LDDX	DB	17	DEC	HL	CALL	XY.STDX	DB	17	RETFD.FDUP:	CALL	UK.KBW	LD	A,(IX+9)	OR	(IX+10)	JP	Z,FD.BMGF	CALL	UR.KBR	CALL	XY.LIDX	DB	9	PUSH	HL	POP	BC	CALL	UK.KSPFB	RETFD.SDOW:	CALL	FD.SDOUT	LD	A,B	AND	C	CP	0FFH	JR	Z,FD.SDK1	CP	0FEH	JR	Z,FD.SDK2	JP	FD.FDOW4FD.SDK2:	EX	DE,HL	CALL	FD.FDUP	LD	A,09H	CALL	UK.PUTK	DEC	BCFD.SDK0:	LD	A,';'	CALL	UK.PUTK	DEC	BC	EX	DE,HL	JP	FD.FDOW4FD.SDK1:	EX	DE,HL	CALL	FD.FDUP	JR	FD.SDK0;--------------------------------------------------------------;        Startroutine Ein-/Ausgabe;FD.FSTRT:	CALL	U1.BILO	CALL	U1.KTINI	LD	A,(UE.BWSA+326H)	CALL	U1.TST	JP	C,FD.STRT1	LD	(IX+3),A	CALL	UR.KRE	CALL	UR.KRWW	CALL	U1.DSVG	LD	A,14	LD	(UB.ZN),A	LD	A,(UE.BWSA+328H)	CP	'S'	JR	Z,$+4	LD	A,'F'	LD	D,A	LD	(UB.PAR2),A	LD	HL,UA.ZKSDT	JR	Z,$+5	LD	HL,UA.ZKDAT	CALL	UR.MIMOFD.STRT1:	POP	IY	RET	C	PUSH	IY	LD	A,'S'	CP	D	CALL	Z,FD.DECHL	CALL	FD.DASU	CALL	C,FD.SETJ	CALL	NC,FD.SETN	RETFD.SETJ:	PUSH	BC	PUSH	DE	PUSH	HL	EX	DE,HL	LD	B,8	INC	DE	DJNZ	$-1	LD	HL,UE.PUF+8	LD	BC,6	LDIR	POP	HL	POP	DE	POP	BC	LD	A,'J'	JR	$+4FD.SETN:	LD	A,'N'	LD	(UB.PAR1),A	RETFD.DECHL:	DEC	HL	DEC	HL	RET;****************************************************************;        Ausgabeprogramm;****************************************************************	DW	$	DB	'AUS 'FD.FOUT1:	CALL	FD.FSTRT	LD	A,(UB.PAR1)	CP	'J'	;DATEI SCHON VORHANDEN ?	JP	Z,FD.FOLWR	;JA;-------------------------------NEIN--> NEUE ERSTELLEN-----------------	LD	A,C	;NEXT RECORD	LD	(UB.PAR1),A	LD	A,7FH	LD	(UB.PAR3),A	;PARAMETER KOMMENTARABFRAGE JA	CALL	U1.VZS	;NEUEN VERZ.SATZ SCHREIBEN	CALL	FD.POSK	PUSH	BC	CALL	FD.FDOUT	PUSH	HL	;BLOCKZAEHLER	CALL	UR.KBM	LD	HL,32	CALL	XY.STIDX	DB	9	CALL	U1.VSX	POP	HL	POP	BC	PUSH	HL	LD	A,C	INC	A	LD	(UE.PUF),A	PUSH	AF	LD	(IX+4),00H	CALL	UF.EXEC	CALL	UR.KRWW	CALL	U1.DSVG	CALL	UR.KBR	POP	AF	LD	(UE.PUF+1),A	LD	A,B	INC	A	LD	(UE.PUF+3),A	LD	(IX+4),00H	CALL	UF.EXEC	LD	(IX+4),02H	CALL	UF.EXEC	DJNZ	$-3	CALL	UR.KBR	POP	HL	LD	(UE.PUF+25),HL	LD	(IX+4),00H	CALL	UF.EXECFD.END:	CALL	UR.KRW	CALL	UR.KRA	RETFD.FOLWR:	LD	HL,UA.ZKDL	;DATEI UEBERSCHREIBEN?	CALL	UR.MIMO	RET	C	LD	A,(HL)	CP	'J'	RET	NZ	CALL	FD.POSK	CALL	FD.FDOWR	CALL	FD.DSPBB	CALL	FD.RDEND	CALL	FD.DSPBG	JR	$-33;**********************************************************************;      Eingabeprogramm;**********************************************************************	DW	$	DB	'EIN 'FD.FDIN2:	CALL	FD.FSTRT	LD	A,(UB.PAR1)	CP	'J'	JR	Z,$+9	LD	A,91H	CALL	UF.ERANZ	JR	FD.END	CALL	FD.POSK	CALL	FD.FDINP	CALL	FD.DSPBB	CALL	FD.RDEND	CALL	FD.DSPBG	JR	FD.END;----------------------------------------------------------------------FD.DSPBB:	CALL	XY.LDDX	DB	17	EX	DE,HL	LD	HL,UA.ZKBEL	CALL	UR.MIMO	EX	DE,HL	CALL	UC.CVBD3	RETFD.DSPBG:	CALL	XY.LDDX	DB	17	EX	DE,HL	LD	HL,UA.ZKBLG	JR	$-16FD.RDEND:	CALL	UK.KBW	LD	A,(IX+9)	OR	(IX+10)	RET	Z	JR	FD.RDENDFD.BMGF:	LD	A,95H	CALL	UF.ERANZ	POP	DE	POP	DE	RET;----------------------------------------------------------------------;	END